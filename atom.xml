<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://asynchronemind.github.io</id>
    <title>Asynn</title>
    <updated>2024-07-29T07:44:25.648Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://asynchronemind.github.io"/>
    <link rel="self" href="https://asynchronemind.github.io/atom.xml"/>
    <subtitle>ä¹ æƒ¯æ— å¸¸æ‰ä¼šåº†å¹¸ã€‚</subtitle>
    <logo>https://asynchronemind.github.io/images/avatar.png</logo>
    <icon>https://asynchronemind.github.io/favicon.ico</icon>
    <rights>All rights reserved 2024, Asynn</rights>
    <entry>
        <title type="html"><![CDATA[åŸºäºè°ƒæ•´åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒå¤–å‘¼å¹¶å‘æ€§èƒ½æå‡]]></title>
        <id>https://asynchronemind.github.io/post/ji-yu-diao-zheng-fen-bu-shi-suo-de-he-xin-wai-hu-bing-fa-xing-neng-ti-sheng/</id>
        <link href="https://asynchronemind.github.io/post/ji-yu-diao-zheng-fen-bu-shi-suo-de-he-xin-wai-hu-bing-fa-xing-neng-ti-sheng/">
        </link>
        <updated>2024-07-20T10:49:13.000Z</updated>
        <content type="html"><![CDATA[<h2 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°</h2>
<p>åœ¨å‰å‡ å¤©å·¥ä½œæ—¥å¤„ç†å®Œéœ€æ±‚åçœ‹äº†çœ‹æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼š<strong>å‘èµ·å¤–å‘¼</strong>çš„æºç å®ç°ã€‚<br>
å…·ä½“å®ç°æµç¨‹ï¼š<br>
<img src="https://asynchronemind.github.io/post-images/1721473754429.png" alt="" loading="lazy"><br>
åœ¨<code>FreeSwitchClientUtil</code>ä¸­å­˜åœ¨ï¼š</p>
<pre><code class="language-java">public static void callOut(String bussType, String command, String api){ // è°ƒç”¨çš„ä¸»æ–¹æ³•
    getInstace(getClusterId(bussType)).callOut(command, api);
}

private static FreeswitchClient getInstace(String clusterId) {
    FreeswitchClient instance = null;
    if (clusterMap.get(clusterId) == null){
        synchronized (FreeswitchClientUtil.class){
            FreeswitchNginxInfo info = staticFreeswitchInfoService.getNginxInfo(clusterId).getObj();
            if (info == null){
                throw new RuntimeException(&quot;æœªè·å–åˆ°é›†ç¾¤ä¿¡æ¯,clusterId : &quot; + clusterId);
            }
            if (clusterMap.get(clusterId) == null){
                instance = new FreeswitchClient(clusterId, info.getAddr(), info.getAuthorization());
                clusterMap.put(clusterId, instance);
            }
        }
    } else {
        instance = clusterMap.get(clusterId);
    }
    // ...
}

/**
    * æ ¹æ®ä¸šåŠ¡ç±»å‹åˆ†æµç­–ç•¥é€‰æ‹©é›†ç¾¤ID
    * */
private static String getClusterId(String bussType) {
    String clusterId = &quot;&quot;;
    List&lt;FreeswitchRouteConf&gt; list = null;
    if (bussTypeRouteMap.get(bussType) == null){
        synchronized (FreeswitchClientUtil.class){
            list = staticFreeswitchInfoService.getRouteConf(bussType).getObj();
            bussTypeRouteMap.put(bussType, list);
        }
    } else {
        list = bussTypeRouteMap.get(bussType);
    }
    if (CollectionUtils.isEmpty(list)){
        throw new RuntimeException();
    }
    // ...
}
</code></pre>
<p>å…¶ä¸­<code>clusterMap</code>ã€<code>bussTypeRouteMap</code>éƒ½æ˜¯<code>ConcurrentHashMap</code>ã€‚<br>
äºæ˜¯æˆ‘ä¾¿å‘ç°é—®é¢˜ï¼š</p>
<ol>
<li><code>synchronized (FreeswitchClientUtil.class)</code>é”ç²’åº¦å¤ªç²—ã€‚</li>
<li><code>synchronized</code>å’Œçº¿ç¨‹å®‰å…¨çš„<code>ConcurrentHashMap</code>é‡å å¥—ç”¨ï¼Œå¹¶ä¸”<code>ConcurrentHashMap</code>ä¸­æ²¡æœ‰<strong>éåŸå­</strong>æ“ä½œï¼Œå¯ä»¥å®Œå…¨ä¿éšœå¹¶å‘å®‰å…¨æ€§ã€‚</li>
<li><strong>æ ¸å¿ƒåœ¨äºå¯¹éçº¿ç¨‹å®‰å…¨çš„<code>list</code>è¿›è¡Œå†™å…¥æ“ä½œ</strong>ã€‚</li>
</ol>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<ol>
<li>ç»†åŒ–<code>synchronized</code>é”ç²’åº¦ï¼Œæ”¹æˆå¯¹<strong>å†™</strong>éçº¿ç¨‹å®‰å…¨çš„<code>list</code>åŠ é”ï¼š<code>synchronized (list)</code>ã€‚</li>
</ol>
<h2 id="æ€§èƒ½æå‡">æ€§èƒ½æå‡</h2>
<p>æ›´æ”¹åï¼Œå¤–å‘¼æ•°é‡ç”±æ¯åˆ†é’Ÿ1wé€šæå‡ä¸º1.8wé€šï¼Œæ€§èƒ½æå‡<strong>1.8å€</strong>ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åŸºäº Redis å®ç°æ¬¡æ•°é™é¢é…ç½®]]></title>
        <id>https://asynchronemind.github.io/post/ji-yu-redis-shi-xian-ci-shu-xian-e-pei-zhi/</id>
        <link href="https://asynchronemind.github.io/post/ji-yu-redis-shi-xian-ci-shu-xian-e-pei-zhi/">
        </link>
        <updated>2024-07-20T09:24:11.000Z</updated>
        <content type="html"><![CDATA[<h2 id="éœ€æ±‚æè¿°">éœ€æ±‚æè¿°</h2>
<p>éœ€è¦æ–°å¢ä¸€ä¸ªåŠŸèƒ½ï¼šå¤–å‘¼æ¬¡æ•°è¾¾åˆ°ä¸Šé™åœæ­¢å¤–å‘¼ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<ul>
<li>åŸæ¥çš„æµç¨‹å›¾ï¼š<br>
<img src="https://asynchronemind.github.io/post-images/1721469538795.png" alt="" loading="lazy"></li>
<li>ç°åœ¨çš„æµç¨‹å›¾ï¼š<br>
<img src="https://asynchronemind.github.io/post-images/1721469607830.png" alt="" loading="lazy"></li>
</ul>
<h3 id="è¯¦ç»†æµç¨‹">è¯¦ç»†æµç¨‹</h3>
<ol>
<li>å­˜å‚¨ç»“æ„é€‰æ‹©ï¼š</li>
</ol>
<ul>
<li>Hashï¼šå­˜å‚¨ç»“æ„è®¾ä¸º&lt;ä¸åŒä»»åŠ¡ç±»å‹å‰ç¼€ï¼Œ&lt;å®¢æˆ·æ‰‹æœºå·ï¼Œæ¬¡æ•°&gt;&gt;ã€‚</li>
<li><strong>é”®å€¼å¯¹</strong>ï¼šå­˜å‚¨ç»“æ„è®¾ä¸º&lt;ä¸åŒä»»åŠ¡ç±»å‹å‰ç¼€_å®¢æˆ·æ‰‹æœºå·ï¼Œæ¬¡æ•°&gt;ã€‚<br>
å› ä¸ºå…¬å¸å·²å­˜åœ¨<code>Redis</code>å¯¹åº”å·¥å…·ç±»ï¼Œå…¶ä¸­å¹¶æ²¡æœ‰å¯¹<code>Hash</code>æ•°æ®ç»“æ„çš„é”®è®¾ç½®è¿‡æœŸæ—¶é—´çš„å®ç°ï¼Œæ‰€ä»¥é€‰ç”¨<strong>é”®å€¼å¯¹</strong>ä½œä¸ºæœ€ç»ˆå®ç°æ–¹æ¡ˆå­˜å‚¨ç»“æ„ã€‚</li>
</ul>
<ol start="2">
<li>
<p>åˆç‰ˆæ–¹æ¡ˆï¼š</p>
<ul>
<li>å®ç°è¿‡ç¨‹åœ¨ä¸Šé¢æµç¨‹å›¾ä¸­å·²ç»è¯´æ˜æ¸…æ¥šï¼Œè®°å½•å‘¼å«æ¬¡æ•°ç†æ‰€å½“ç„¶é€‰ç”¨<code>increment</code>æ“ä½œå®ç°ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºå½“å¤©å‰©ä½™æ—¶é—´ã€‚å› ä¸ºè¦åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œæ‰€ä»¥æŠ½è±¡å‡ºä¸€ä¸ªæ–¹æ³•æ¥ï¼š<pre><code class="language-java">@Component
public class HhtRedisUtil extends RedisUtil {
    public void setOrIncr(String key) {
        if(!keyExists(key)) {
            Calendar now = Calendar.getInstance();
            Calendar endOfDay = (Calendar) now.clone();
            endOfDay.set(Calendar.HOUR_OF_DAY, 23);
            endOfDay.set(Calendar.MINUTE, 59);
            endOfDay.set(Calendar.SECOND, 59);
            endOfDay.set(Calendar.MILLISECOND, 999);
            long expireTime = endOfDay.getTimeInMillis() - now.getTimeInMillis();
            expireTime = Math.max(1, expireTime / 1000L);
            set(key, &quot;1&quot;, expireTime);
        } else {
            incr(key, 1);
        }
    }
}
</code></pre>
</li>
<li>å…·ä½“å­˜å‚¨è¿‡ç¨‹ï¼š<pre><code class="language-java">if(!StrUtils.isNil(calloutConfFeignService.getSysParam(prefix, true).getObj())) { // ç”Ÿäº§å¿…ä¸å¯å°‘çš„å¼€å…³ 0.0
    String redisKey = prefix + &quot;_&quot; + EncryptAndDecryptUtil.encrypt(OperType.ENCRYPT, EDataType.PHONE_NO,record.getCalledNum());
    hhtRedisUtil.setOrIncr(redisKey);
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>é¢ä¸´çš„é—®é¢˜ï¼š<br>
å› ä¸ºä¹‹å‰æ‰€å®ç°çš„<code>RedisUtil</code>ä¸­æ³¨å…¥çš„ä¸ºï¼š</p>
<pre><code class="language-java">public class RedisUtil {
 @Autowired
 private RedisTemplate&lt;String, String&gt; redisTemplate;

</code></pre>
<p>å¯¼è‡´é”®å€¼å¯¹åˆå§‹åŒ–æ—¶è®¾ç½®çš„å€¼ä¸º<code>String</code>ç±»å‹çš„&quot;1&quot;ï¼Œè‡´ä½¿åç»­çš„<code>incr(key, 1)</code>å› ä¸ºç±»å‹ä¸åŒ¹é…è€Œ<strong>æŠ¥é”™</strong>ã€‚</p>
</li>
<li>
<p>æœ€ç»ˆè§£å†³æ€è·¯ï¼š</p>
<ul>
<li>é¦–å…ˆå·¥å…·ç±»æ˜¯è‚¯å®šä¸èƒ½æ”¹çš„ï¼Œå› ä¸ºåˆ«çš„åœ°æ–¹å·²ç»ä½¿ç”¨è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œæ”¹äº†ä¸çŸ¥é“ä¼šå‡ºå•¥é—®é¢˜ï¼Œæ‰€ä»¥<strong>æ”¹æ³›å‹</strong>çš„æ€è·¯è¢«å¦å†³ã€‚</li>
<li>ç„¶åäº†è§£åˆ°<code>Redis</code>çš„<code>increment</code>åœ¨<strong>é”®ä¸å­˜åœ¨æ—¶ä¼šæ–°å»º</strong>ï¼Œå¹¶è¿”å›å€¼ä¸º1ã€‚äºæ˜¯æ”¹ä¸ºï¼š<pre><code class="language-java">public void setOrIncr(String key) {
    long pnt = incr(key, 1);
    if(pnt == 1L) {
        Calendar now = Calendar.getInstance();
        Calendar endOfDay = (Calendar) now.clone();
        endOfDay.set(Calendar.HOUR_OF_DAY, 23);
        endOfDay.set(Calendar.MINUTE, 59);
        endOfDay.set(Calendar.SECOND, 59);
        endOfDay.set(Calendar.MILLISECOND, 999);
        long expireTime = endOfDay.getTimeInMillis() - now.getTimeInMillis();
        expireTime = Math.max(1, expireTime  / 1000L);
        setExpire(key, expireTime);
        }
    }
}
</code></pre>
äºæ˜¯é—®é¢˜è§£å†³ã€‚</li>
</ul>
</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åŸºäºå®šæ—¶ä»»åŠ¡å®ç° Kafka æ¶ˆæ¯å¤šæ¬¡æŠ•æ”¾]]></title>
        <id>https://asynchronemind.github.io/post/ji-yu-ding-shi-ren-wu-shi-xian-kafka-xiao-xi-duo-ci-tou-fang/</id>
        <link href="https://asynchronemind.github.io/post/ji-yu-ding-shi-ren-wu-shi-xian-kafka-xiao-xi-duo-ci-tou-fang/">
        </link>
        <updated>2024-07-14T08:15:27.000Z</updated>
        <content type="html"><![CDATA[<h2 id="éœ€æ±‚æè¿°">éœ€æ±‚æè¿°</h2>
<p>å‰é¢æåˆ°ä¸ä¸‹æ¸¸é¡¹ç›®è¿›è¡Œå¯¹æ¥æ—¶ï¼Œå…¶ä¸­ä¸€ç±»å¯¹æ¥é€”å¾„ç”±<code>kafka</code>æ¥å®ç°ã€‚<br>
éœ€è¦å°†ç”±æœ¬é¡¹ç›®å®ç°å¹¶è®°å½•çš„å¤šç±»ä¿¡æ¯æŠ•æ”¾è‡³<code>kafka</code>çš„åŒä¸€Topic: <code>XXX_LOG_TO_PRODUCER</code>ä¸‹ã€‚<br>
æµç¨‹å›¾å¦‚ä¸‹ï¼š<br>
<img src="https://asynchronemind.github.io/post-images/1720946220284.png" alt="" loading="lazy"><br>
æˆ‘ä»¬çŸ¥é“ï¼Œç°æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚ï¼šKafkaã€RocketMQç­‰ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„é²æ£’æ€§ï¼Œéƒ½å®ç°äº†å„è‡ªçš„é‡å¤æ¶ˆè´¹æœºåˆ¶ã€‚<br>
ä½†æ˜¯ï¼Œ<strong>åœ¨ä¸Šè¿°æµç¨‹å›¾ä¸­å´æ²¡æœ‰ä¸€ä¸ªä¿éšœæ¶ˆæ¯èƒ½å¤Ÿè¢«å®‰å…¨æŠ•æ”¾è‡³<code>Producer</code>çš„æªæ–½ã€‚</strong><br>
è™½ç„¶æˆ‘åœ¨<code>sendToKafka</code>ä¸­ä½¿ç”¨äº†<code>try...catch...</code>æ¥æ•è·å¯èƒ½å‡ºç°çš„å¼‚å¸¸å¹¶è®°å½•åœ¨æ—¥å¿—é‡Œï¼Œä½†è¿™ç§æ–¹æ³•åªèƒ½èµ·ä¸€ä¸ªæé†’ä½œç”¨ï¼Œè¿˜æ˜¯å¾—åœ¨èŠ±è´¹æ—¶é—´æŸ¥çœ‹<strong>é”™è¯¯æ—¥å¿—</strong>çš„æƒ…å†µä¸‹æ‰ç”Ÿæ•ˆï¼Œå¹¶ä¸èƒ½æ»¡è¶³ä¸Šè¿°éœ€æ±‚ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>ç”±äºæœ€è¿‘æ­£å¥½åœ¨çœ‹é¡¹ç›®ä¸­ä½¿ç”¨å®šæ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œä¾¿æƒ³åˆ°äº†æ˜¯å¦èƒ½å¤šå¢åŠ ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¥å®ç°æŠ•æ”¾æ¶ˆæ¯ï¼Œä»è€Œè§£å†³æ¶ˆæ¯æŠ•æ”¾å®‰å…¨çš„é—®é¢˜ã€‚<br>
<img src="https://asynchronemind.github.io/post-images/1720948805082.png" alt="" loading="lazy"><br>
è·Ÿmtæ²Ÿé€šäº¤æµäº†ä¸€ä¸‹ä¹‹åï¼Œmtè¡¨ç¤ºè‚¯å®šï¼Œä¾¿æ‰¾äº§å“ç»™æˆ‘æäº†è¿™ä¸ªéœ€æ±‚ğŸ˜²ã€‚<br>
å› ä¸ºå…¬å¸é¡¹ç›®å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ç»„ä»¶ä½¿ç”¨çš„æ˜¯<code>Saturn</code>ï¼Œåœ¨è¿™é‡Œå°±ä¸æ¯”è¾ƒå¸‚é¢ä¸Šç°å­˜çš„å®šæ—¶ä»»åŠ¡å®ç°æ–¹æ¡ˆå­°ä¼˜å­°åŠ£äº†ã€‚</p>
<h3 id="ä»‹ç»ä¸€ä¸‹saturn">ä»‹ç»ä¸€ä¸‹<code>Saturn</code>ï¼š</h3>
<figure data-type="image" tabindex="1"><img src="https://asynchronemind.github.io/post-images/1722238970302.png" alt="" loading="lazy"></figure>
<ul>
<li>å”¯å“ä¼šè‡ªä¸»ç ”å‘çš„åˆ†å¸ƒå¼çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œç›®çš„æ˜¯å–ä»£ä¼ ç»Ÿçš„Linux Cronã€Spring Batch Jobã€Quartzçš„æ–¹å¼ï¼Œåšåˆ°å…¨åŸŸç»Ÿä¸€é…ç½®ï¼Œç»Ÿä¸€ç›‘æ§ï¼Œä»»åŠ¡é«˜å¯ç”¨ä»¥åŠåˆ†ç‰‡ã€‚</li>
<li>æ”¯æŒåŸºäºæ—¶é—´å’Œäº‹ä»¶è§¦å‘ã€äººå·¥æŒ‡å®šèµ„æºåˆ†é…ç­–ç•¥å’Œè‡ªåŠ¨å¹³è¡¡ç­–ç•¥ç»“åˆã€ä»»åŠ¡å¼€å‘è¯­è¨€ä¸å—é™åˆ¶ã€æ”¯æŒä¸€æœºä¸€åˆ†ç‰‡çš„æœ¬åœ°åŒ–æ¨¡å¼ä»»åŠ¡è°ƒåº¦ã€ä»»åŠ¡æŒ‰åˆ†ç‰‡æ‰§è¡Œã€æ¡†æ¶å’Œä¸šåŠ¡ä»£ç éš”ç¦»ã€åˆ†ç‰‡çš„è°ƒåº¦æŒ‰è´Ÿè½½å‡è¡¡åˆ†å¸ƒã€å¯è§†åŒ–ç®¡ç†ã€æ”¯æŒç§’çº§ä»»åŠ¡è§¦å‘ã€å¯è§†åŒ–ç›‘æ§å’ŒæŠ¥è­¦ã€æ”¯æŒå®¹å™¨åŒ– (Docker) éƒ¨ç½²ã€‚</li>
</ul>
<h3 id="å…·ä½“ä½¿ç”¨">å…·ä½“ä½¿ç”¨ï¼š</h3>
<ol>
<li>æ·»åŠ <code>pom</code>ã€‚</li>
<li>ç»§æ‰¿<code>AbstractSaturnJavaJob</code>ç±»ï¼Œé‡å†™<code>handleJavaJob</code>æ–¹æ³•ã€‚<pre><code class="language-java">@Slf4j
@Component
public class RePushCalllogJob extends AbstractSaturnJavaJob {

    @Override
    public SaturnJobReturn handleJavaJob(String jobName, Integer shardItem, String shardParam, SaturnJobExecutionContext saturnJobExecutionContext) throws InterruptedException {
        long begin = System.currentTimeMillis();
        SaturnJobReturn saturnJobReturn = new SaturnJobReturn();
        log.info(&quot;RePushCalllogJob job start: jobName={}, shardItem={}, shardParam={}, jobParameter={}&quot;, jobName, shardItem, shardParam, saturnJobExecutionContext.getJobParameter().trim());
        try {
            process(shardParam);
            saturnJobReturn.setReturnMsg(&quot;Execute RePushCalllogJob successfully&quot;);
        } catch (Exception e) {
            log.warn(&quot;Execute RePushCalllogJob failed&quot;, e);
            saturnJobReturn.setReturnMsg(&quot;Execute RePushCalllogJob failed&quot;);
            saturnJobReturn.setReturnCode(-1);
        }
        log.info(&quot;RePushCalllogJob job end: duration={}&quot;, System.currentTimeMillis() - begin);
        return saturnJobReturn;
    }
</code></pre>
</li>
<li>å…·ä½“æŠ•æ”¾ä»»åŠ¡å®ç°ã€‚<pre><code class="language-java">private void process(String shardParam) {
    if (StringUtils.isBlank(shardParam)) {
        log.warn(&quot;Shard param is empty&quot;);
        return;
    }
    String[] tempStr = StringUtils.split(shardParam, &quot;#&quot;);
    long start = Long.parseLong(tempStr[1]);
    long end = Long.parseLong(tempStr[2]) + 1;//startå’Œendéƒ½è¦æ‰§è¡Œ
    if (start &gt;= end) {
        log.warn(&quot;ID range is invalid&quot;);
        return;
    }
    for (long offStart = start; offStart &lt; end; offStart = offStart + PAGE_SIZE) {
        long offEnd = Math.min(offStart + PAGE_SIZE, end);

        switch (tempStr[0].toLowerCase()) {
            case &quot;aaa_calllog&quot;:
                processaaaCallLog(offStart, offEnd);
                break;
            case &quot;bbb_calllog&quot;:
                processbbbCallLog(offStart, offEnd);
                break;
            case &quot;ccc_calllog&quot;:
                processcccCallLog(offStart, offEnd);
                break;
            case &quot;dddr_calllog&quot;:
                processdddrCallLog(offStart, offEnd);
                break;
            case &quot;eee_calllog&quot;:
                processeeeCallLog(offStart, offEnd);
                break;
            default:
                log.warn(&quot;Unknown call log&quot;);
                return;
        }
    }
}
</code></pre>
</li>
<li>è®¾ç½®å¼€å¯æ—¶é—´ã€‚</li>
</ol>
<h3 id="åç»­æµç¨‹">åç»­æµç¨‹ï¼š</h3>
<ol>
<li>å¯ä»¥å‘ç°æˆ‘ä»¬åªæ˜¯å®ç°æ ¹æ®æ•°æ®èŒƒå›´è¿›è¡Œæ‰¹é‡æŠ•æ”¾ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä¸‹æ¸¸ä»»åŠ¡é‡å¤æ¶ˆè´¹çš„é—®é¢˜ï¼Œéœ€è¦ä¸ä¸‹æ¸¸è¿›è¡Œæ‹‰é€šï¼Œè®©ä»–ä»¬åŠ ä¸Šä¸€ä¸ª<strong>å¹‚ç­‰</strong>é€»è¾‘ï¼Œ<strong>é˜²æ­¢æ¶ˆæ¯é‡å¤æ¶ˆè´¹</strong>ã€‚</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spring è‡ªåŠ¨æ³¨å…¥ä¸º null çš„é—®é¢˜æ’æŸ¥]]></title>
        <id>https://asynchronemind.github.io/post/spring-zi-dong-zhu-ru-wei-null-de-wen-ti-pai-cha/</id>
        <link href="https://asynchronemind.github.io/post/spring-zi-dong-zhu-ru-wei-null-de-wen-ti-pai-cha/">
        </link>
        <updated>2024-07-09T14:21:53.000Z</updated>
        <content type="html"><![CDATA[<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>åœ¨å‰æ–‡ä½¿ç”¨ç­–ç•¥æ¨¡å¼æŠ½è±¡æ¶ˆæ¯æ¨é€<code>kafka</code>åï¼Œç¬¬ä¸€æ¬¡æ¨æµ‹è¯•æµæ°´çº¿æœç„¶æŠ¥é”™ã€‚<br>
è¿œç¨‹<code>bash</code>å®¹å™¨æŸ¥çœ‹æ—¥å¿—ï¼Œå¯¹åº”å…·ä½“å®ç°ç±»ä¸­æŠ•æ”¾<code>Topic</code>çš„ç”Ÿäº§è€…æ–¹æ³•çˆ†<strong>ç©ºæŒ‡é’ˆå¼‚å¸¸</strong>ï¼š</p>
<pre><code class="language-java">@Autowired
private CalllogProducer calllogProducer;

calllogProducer.sendMsg(JSONObject.toJSONString(calllog));
</code></pre>
<p>æ³¨å…¥ä¸è¿›å»çš„ç°è±¡è®©æˆ‘ååˆ†ä¸è§£ã€‚</p>
<h2 id="å®šä½">å®šä½</h2>
<p>åœ¨ç½‘ä¸ŠæŸ¥æ‰¾ç›¸å…³å†…å®¹ï¼Œå¿«é€Ÿå®šä½åˆ°<strong>Springä¸ä¼šä¸ºä¸æ˜¯ç”±å®ƒåˆ›å»ºçš„å¯¹è±¡è¿›è¡Œä¾èµ–æ³¨å…¥</strong>ã€‚<br>
åŸå› å‡ºåœ¨ï¼š</p>
<pre><code class="language-java">strategies.put(HhtTaskData.class, new HhtKafkaSendStrategy());
strategies.put(HhtReceiveTask.class, new HhtReceiveKafkaSendStrategy());
strategies.put(CalloutDetailRecord.class, new OrderKafkaSendStrategy());
strategies.put(AbnAsrDetailRecordReq.class, new AbnKafkaSendStrategy());
</code></pre>
<p>æ³¨å†Œå…·ä½“å®ç°æ–¹æ³•æ—¶ï¼Œæ‰‹åŠ¨<code>new</code>å‡ºæ¥äº†å®ç°æ–¹æ³•å¯¹è±¡ã€‚</p>
<h2 id="è§£å†³">è§£å†³</h2>
<ol>
<li>èµ·åˆæƒ³ç”¨<code>@Autowired</code>ç»™<code>Spring</code>æ¥åˆ›å»ºå…·ä½“å®ç°æ–¹æ³•å¯¹è±¡ï¼Œä½†ç´§æ¥ç€éœ€è¦æ”¹åŠ¨<code>strategies</code>åŸæœ¬æ•°æ®ç»“æ„ï¼š<code>HashMap&lt;Class&lt;?&gt;, KafkaSendStrategy&gt;</code>ï¼Œä»¥åŠåˆ†å‘ç­–ç•¥ï¼Œååˆ†éº»çƒ¦ã€‚</li>
<li>è½¬æ¢æ€è·¯ï¼Œæ”¾å¼ƒ<code>Spring</code>æ³¨å…¥<code>CalllogProducer</code>ï¼Œè€Œæ˜¯æ›´æ”¹ç”Ÿäº§è€…æ–¹æ³•ä¸ºé™æ€ï¼Œæ”¹åŠ¨è¾ƒå°ï¼Œå¹¶ä¸”åˆ«çš„åœ°æ–¹çš„å¼•ç”¨ä¹Ÿä¾¿äºå®šä½ï¼š<pre><code class="language-java"> private ProducerPool producerPool; -&gt;  private static ProducerPool producerPool;
 private String topic; -&gt; private static String topic;

 public void sendMsg(String msg) { } -&gt; public static void sendMsg(String msg) { }
 
 // ç„¶ååœ¨å®ç°ç±»ä¸­è°ƒç”¨
 CalllogProducer.sendMsg(JSONObject.toJSONString(calllog));
</code></pre>
</li>
</ol>
<pre><code>
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åŸºäºç­–ç•¥æ¨¡å¼å®ç°å¤šä¸ªæ–¹æ³•æŠ½è±¡åŒ–]]></title>
        <id>https://asynchronemind.github.io/post/ji-yu-ce-lue-mo-shi-shi-xian-duo-ge-fang-fa-chou-xiang-hua/</id>
        <link href="https://asynchronemind.github.io/post/ji-yu-ce-lue-mo-shi-shi-xian-duo-ge-fang-fa-chou-xiang-hua/">
        </link>
        <updated>2024-07-07T02:32:15.000Z</updated>
        <content type="html"><![CDATA[<h2 id="éœ€æ±‚æè¿°">éœ€æ±‚æè¿°</h2>
<p>æˆ‘ä»¬æ‰€è´Ÿè´£é¡¹ç›®å±äºä¸€ä¸ªä¸­é—´é¡¹ç›®ï¼Œéœ€è¦ä¸ä¸‹æ¸¸é¡¹ç›®è¿›è¡Œå¯¹æ¥ï¼Œå…¶ä¸­ä¸€ç±»å¯¹æ¥é€”å¾„ç”±<code>kafka</code>æ¥å®ç°ã€‚<br>
éœ€è¦å°†ç”±æœ¬é¡¹ç›®å®ç°å¹¶è®°å½•çš„å¤šç±»ä¿¡æ¯æŠ•æ”¾è‡³<code>kafka</code>çš„åŒä¸€<code>Topic: XXX_LOG_TO_PRODUCER</code>ä¸‹ã€‚</p>
<h2 id="ç°æœ‰æˆæœ">ç°æœ‰æˆæœ</h2>
<p>å·²å­˜åœ¨ä¸€ä¸ªå‡½æ•°å¯¹Aç±»ä¿¡æ¯è¿›è¡ŒæŠ•æ”¾ï¼š</p>
<pre><code class="language-java">private void sendToKafka(AAADetailRecord record, AAATaskData Task, AAATemplate Template) 
</code></pre>
<p>è°ƒç”¨æ—¶æœºä¸ºAç±»ä¿¡æ¯è½åº“æ—¶ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<ul>
<li>å·²çŸ¥ä¿¡æ¯ï¼š
<ol>
<li>å…¶ä½™ç±»ä¿¡æ¯å‡å·²å®ç°è½åº“æ“ä½œã€‚</li>
<li>ä¸åŒç±»å…·æœ‰ä¸åŒçš„ä»»åŠ¡<code>id</code>æ ‡è¯†ã€‚</li>
<li>æŠ•æ”¾åˆ°<code>kafka</code>éœ€æœ‰ç»Ÿä¸€çš„<code>json</code>å­—æ®µã€‚</li>
</ol>
</li>
<li>è§£å†³æ€è·¯
<ol>
<li>åœ¨æ¯ä¸€ä¸ªç±»çš„è½åº“æ“ä½œä¸­å®šä¹‰å¯¹åº”ç±»çš„æŠ•æ”¾å‡½æ•°ã€‚ï¼ˆç›´è§‰å®ç°æ–¹å¼ï¼Œä½†å¤ªå†—ä½™ï¼Œä¸æƒ³å»å†™ã€‚ï¼‰</li>
<li>åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ç±»ï¼Œä¼ å‚æŠ½è±¡å‡ºä¸€ä¸ªçˆ¶ç±»å±æ€§ï¼Œå¦‚<code>XXXDetailRecord</code>ã€‚ï¼ˆéœ€è¦é‡æ–°å®šä¹‰æŠ½è±¡å®ä½“ä»¥åŠæ‰¾åˆ°æ¯ä¸ªç±»ä¸­æºå¸¦ä¿¡æ¯çš„å®ä½“ï¼Œå¤ªéº»çƒ¦ï¼Œå¹¶ä¸”æ”¹åŠ¨å¾ˆå¤§ã€‚ï¼‰<pre><code class="language-java">public class KafkaSender {

    public void sendToKafka(XXXDetailRecord record, XXXTaskData Task, XXXTemplate Template)
}
</code></pre>
</li>
<li>å®šä¹‰æ³›å‹ã€‚ï¼ˆæ„Ÿè§‰ä¹Ÿä¸å¥½å®ç°ã€‚ï¼‰</li>
<li>æ–¹æ³•é‡è½½ã€‚ï¼ˆè¿˜è¡Œï¼Œä½†æ ‡é¢˜æ˜¯ç­–ç•¥æ¨¡å¼ï¼Œå°±ä¸é‡‡ç”¨äº†ã€‚ï¼‰</li>
<li><strong>ç­–ç•¥æ¨¡å¼</strong>ã€‚</li>
</ol>
</li>
</ul>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</p>
<pre><code class="language-java">public interface KafkaSendStrategy {
    void send(Object... params); // å› ä¸ºå¯èƒ½æ¯ä¸ªç±»å¾—åˆ°å­—æ®µæ‰€éœ€å‚æ•°ä¸ä¸€æ ·ï¼Œæ‰€ä»¥é‡‡ç”¨ä¸å®šå‚æ•°
}
</code></pre>
<p>å®ç°ä¸åŒç­–ç•¥ï¼š</p>
<pre><code class="language-java">public class AAASendStrategy implements KafkaSendStrategy {
    @Override
    public void send(Object... params) {
        AAADetailRecord record = (AAADetailRecord) params[0];
        AAATaskData task = (AAATaskData) params[1];
        AAATemplate template = (AAATemplate) params[2];
        // å¤„ç† AAADetailRecord ç±»å‹å‚æ•°
    }
}

public class AnotherSendStrategy implements KafkaSendStrategy {
    @Override
    public void send(Object... params) {
        AnotherDetailRecord record = (AnotherDetailRecord) params[0];
        AnotherTaskData task = (AnotherTaskData) params[1];
        AnotherTemplate template = (AnotherTemplate) params[2];
        // å¤„ç† AnotherDetailRecord ç±»å‹å‚æ•°
    }
}
</code></pre>
<p>å­˜æ”¾<code>HashMap</code>ï¼š</p>
<pre><code class="language-java">public class KafkaSender {
    private final Map&lt;Class&lt;?&gt;, KafkaSendStrategy&gt; strategies = new HashMap&lt;&gt;();

    public KafkaSender() {
        strategies.put(AAADetailRecord.class, new HhtSendStrategy());
        strategies.put(AnotherDetailRecord.class, new AnotherSendStrategy());
        // æ·»åŠ æ›´å¤šç­–ç•¥
    }

    public void sendToKafka(Object... params) {
        if (params.length &gt; 0) {
            Class&lt;?&gt; paramClass = params[0].getClass(); // æ ¹æ®ä¸åŒç±»ä¿¡æ¯å¾—åˆ°ä¸åŒæ–¹æ³•
            KafkaSendStrategy strategy = strategies.get(paramClass);
            if (strategy != null) {
                strategy.send(params);
            } else {
                throw new IllegalArgumentException(&quot;No strategy found for class: &quot; + paramClass);
            }
        } else {
            throw new IllegalArgumentException(&quot;No parameters provided&quot;);
        }
    }
}
</code></pre>
<p>æœ€åä½¿ç”¨ï¼š</p>
<pre><code class="language-java">KafkaSender kafkaSender = new KafkaSender();
kafkaSender.sendToKafka(record, task, template);
</code></pre>
]]></content>
    </entry>
</feed>